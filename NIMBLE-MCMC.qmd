---
title: "NIMBLEã§MCMC"
author: "ä¼Šæ±å®æ¨¹"
editor: visual
format:
  revealjs:
    theme: [default, custom.scss]
    embed-resources: true
    slide-number: true
lang: ja
date: 2023-07-15
date-format: iso
execute:
  echo: true
---

## è‡ªå·±ç´¹ä»‹

åå‰: ä¼Šæ±å®æ¨¹

å‹¤å‹™å…ˆ: æ£®æ—ç·åˆç ”ç©¶æ‰€ åŒ—æµ·é“æ”¯æ‰€

å…±è¨³æ›¸:

::: {style="margin-left: 2em; text-align: left;"}
[![](https://www.hanmoto.com/bd/img/9784320057807.jpg){fig-alt="BUGSã§å­¦ã¶éšå±¤ãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€" style="vertical-align: top;"}](https://www.hanmoto.com/bd/isbn/9784320057807) [![](https://www.hanmoto.com/bd/img/9784320058149.jpg){fig-alt="ç”Ÿæ…‹å­¦ã®ãŸã‚ã®éšå±¤ãƒ¢ãƒ‡ãƒªãƒ³ã‚°" style="vertical-align: top;"}](https://www.hanmoto.com/bd/isbn/9784320058149)
:::

## NIMBLE

-   BUGSè¨€èªã§ãƒ¢ãƒ‡ãƒ«ã‚’è¨˜è¿°ã—ã€çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¨å®šã‚’ãŠã“ãªã†Rãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
-   ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ: <https://r-nimble.org/>
-   "Numerical Inference for statistical Models for Bayesian and Likelihood Estimation"[^1]
-   2023å¹´5æœˆ31æ—¥ã«Version 1.0.0ãƒªãƒªãƒ¼ã‚¹ï¼ˆç¾åœ¨ã¯1.0.1ï¼‰

[^1]: [https://r-nimble.org/html_manual/cha-welcome-nimble.html#sec:what-is-nimble](https://r-nimble.org/html_manual/cha-welcome-nimble.html#sec:what-is-nimblehttps://r-nimble.org/html_manual/cha-welcome-nimble.html#sec:what-is-nimble)

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ãƒ¢ãƒ‡ãƒ«ã‚’C++ã«å¤‰æ›ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦å®Ÿè¡Œã™ã‚‹ã®ã§ã€é–‹ç™ºç’°å¢ƒãŒå¿…è¦

-   Windows: Rtools
-   macOS: Command Line Tools (ã‚ã‚‹ã„ã¯Xcode)
-   Linuxã»ã‹: ãã‚Œãã‚Œã®é–‹ç™ºç’°å¢ƒ

NIMBLEæœ¬ä½“ã¯æ™®é€šã«CRANã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```{r install}
#| eval: false
install.packages("nimble")
```

## å®Ÿè¡Œä¾‹

ã¾ãšã€nimbleãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿

```{r libarary_nimble}
library(nimble)
```

## ãƒ‡ãƒ¼ã‚¿

```{r data}
#| echo: false
library(posterior)
library(bayesplot)
library(ggplot2)

set.seed(123)
N <- 40
alpha <- 0
beta <- 1
sigma <- 2
X <- runif(N, 0, 10)
Y <- rnorm(N, alpha + beta * X, sigma)
ggplot(data.frame(X, Y)) +
  geom_point(aes(x = X, y = Y), size = 4, alpha = 0.7) +
  theme_gray(base_family = "Helvetica", base_size = 18)
```

## ãƒ¢ãƒ‡ãƒ«ã‚³ãƒ¼ãƒ‰

å›å¸°ãƒ¢ãƒ‡ãƒ«

```{r code}
code <- nimbleCode({
  for (n in 1:N) {
    mu[n] <- alpha + beta * X[n]
    Y[n] ~ dnorm(mu[n], tau)
  }
  alpha ~ dnorm(0, 100)
  beta ~ dnorm(0, 100)
  tau <- 1 / (sigma * sigma)
  sigma ~ dunif(0, 100)
})
```

## NIMBLEã®BUGSæ‹¡å¼µã‚’ä½¿ç”¨ã—ãŸãƒ¢ãƒ‡ãƒ«

```{r code2}
code2 <- nimbleCode({
  for (n in 1:N) {
    Y[n] ~ dnorm(alpha + beta * X[n], sd = sigma)
  }
  alpha ~ dnorm(0, 100)
  beta ~ dnorm(0, 100)
  sigma ~ dunif(0, 100)
})
```

-   å¼•æ•°ã«å¼ã‚’ä½¿ç”¨å¯èƒ½
-   `dnorm`ã®ã°ã‚‰ã¤ãã®æŒ‡å®šã«æ¨™æº–åå·®ã‚’ä½¿ç”¨å¯èƒ½ï¼ˆåˆ†æ•£ã‚‚å¯ï¼‰

## MCMC

`nimbleMCMC`é–¢æ•°ã§ã€ãƒãƒ«ã‚³ãƒ•é€£é–ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ (MCMC) ã«ã‚ˆã‚Šã€ãƒ¢ãƒ‡ãƒ«ã®ã‚ã¦ã¯ã‚ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¨å®šã‚’å®Ÿè¡Œ

```{r fit}
#| output: false
samp <- nimbleMCMC(code = code2,
                   constants = list(N = N),
                   data = list(X = X, Y = Y),
                   niter = 6000, nburnin = 1000,
                   nchains = 3,
                   samplesAsCodaMCMC = TRUE) |>
   posterior::as_draws()
```

æœ€å¾Œã«posteriorãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®drawsã‚¯ãƒ©ã‚¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›

## çµæœã®è¦ç´„

```{r summary}
summary(samp, default_summary_measures(), "rhat")
```

## é€£é–ã®è»Œè·¡ã®ãƒ—ãƒ­ãƒƒãƒˆ

```{r traceplot}
bayesplot::mcmc_trace(samp)
```

## å¯†åº¦ã®ãƒ—ãƒ­ãƒƒãƒˆ

```{r densplot}
bayesplot::mcmc_dens(samp)
```

## ãã®ä»–ã®æ©Ÿèƒ½

-   WAIC (Widely Applicable Information Criterion)
-   ç©ºé–“çµ±è¨ˆãƒ¢ãƒ‡ãƒ«ï¼ˆCAR: Conditional AutoRegressionï¼‰
-   é€æ¬¡ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ï¼ˆç²’å­ãƒ•ã‚£ãƒ«ã‚¿, nimbleSMCãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰

ãªã©ã€æ©Ÿèƒ½è±Šå¯Œï¼ˆè©³ç´°ã¯[å…¬å¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«](https://r-nimble.org/html_manual/cha-welcome-nimble.html)ã‚’ï¼‰

------------------------------------------------------------------------

::: {style="padding-top: 20%; text-align: center; font-size: 400%;"}
ğŸ¥³
:::
